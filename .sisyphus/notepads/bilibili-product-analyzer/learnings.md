# Learnings - Bç«™å•†å“è¯„è®ºåˆ†æå·¥å…·

## Conventions & Patterns
_Accumulated knowledge from task execution_

---

## é¡¹ç›®åˆå§‹åŒ–å®Œæˆ (2026-02-01)

### é¡¹ç›®ç»“æ„
```
Bç«™å•†å“è¯„è®ºè§£æ/
â”œâ”€â”€ backend/              # Goåç«¯ä»£ç 
â”‚   â”œâ”€â”€ ai/              # AIæœåŠ¡é›†æˆæ¨¡å—
â”‚   â”œâ”€â”€ api/             # APIè·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ bilibili/        # Bç«™APIé›†æˆæ¨¡å—
â”‚   â”œâ”€â”€ database/        # æ•°æ®åº“åˆå§‹åŒ–æ¨¡å—
â”‚   â”œâ”€â”€ models/          # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ sse/             # SSEæœåŠ¡ç«¯æ¨¡å—
â”‚   â””â”€â”€ main.go          # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ frontend/            # Reactå‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ src/             # æºä»£ç 
â”‚   â”œâ”€â”€ public/          # é™æ€èµ„æº
â”‚   â””â”€â”€ dist/            # æ„å»ºè¾“å‡º
â”œâ”€â”€ data/                # SQLiteæ•°æ®åº“æ–‡ä»¶ç›®å½•
â”œâ”€â”€ bin/                 # Goç¼–è¯‘è¾“å‡º
â”œâ”€â”€ go.mod               # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ go.sum               # Goä¾èµ–é”æ–‡ä»¶
â””â”€â”€ .gitignore           # Gitå¿½ç•¥é…ç½®
```

### Goæ¨¡å—é…ç½®
- **æ¨¡å—å**: `bilibili-analyzer`
- **æ ¸å¿ƒä¾èµ–**:
  - `github.com/gin-gonic/gin` - Webæ¡†æ¶
  - `gorm.io/gorm` - ORMæ¡†æ¶
  - `gorm.io/driver/sqlite` - SQLiteé©±åŠ¨

### Reactå‰ç«¯é…ç½®
- **æŠ€æœ¯æ ˆ**: React 18 + TypeScript + Vite
- **æ ¸å¿ƒä¾èµ–**:
  - `axios` - HTTPå®¢æˆ·ç«¯
  - `recharts` - å›¾è¡¨åº“
  - `@tailwindcss/postcss` - Tailwind CSS v4 PostCSSæ’ä»¶
  - `autoprefixer` - CSSè‡ªåŠ¨å‰ç¼€
- **æ„å»ºå·¥å…·**: Vite 7.3.1
- **å¼€å‘ç«¯å£**: é»˜è®¤ 5173

### å…³é”®å†³ç­–
1. **Tailwind CSS v4**: éœ€è¦ä½¿ç”¨ `@tailwindcss/postcss` æ’ä»¶è€Œéç›´æ¥ä½¿ç”¨ `tailwindcss`
2. **ç›®å½•åˆ†ç¦»**: å‰åç«¯å®Œå…¨åˆ†ç¦»ï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
3. **æ•°æ®åº“ä½ç½®**: ç»Ÿä¸€å­˜æ”¾åœ¨ `data/` ç›®å½•ï¼Œå·²åŠ å…¥ `.gitignore`
4. **æ„å»ºè¾“å‡º**: GoäºŒè¿›åˆ¶è¾“å‡ºåˆ° `bin/`ï¼ŒReactæ„å»ºè¾“å‡ºåˆ° `frontend/dist/`

### éªŒè¯é€šè¿‡
- âœ… Gitä»“åº“åˆå§‹åŒ–æˆåŠŸ
- âœ… Goæ¨¡å—åˆ›å»ºå¹¶ä¾èµ–å®‰è£…å®Œæˆ
- âœ… Goä»£ç ç¼–è¯‘é€šè¿‡ (`go build -o bin/bilibili-analyzer ./backend`)
- âœ… Reacté¡¹ç›®åˆ›å»ºå¹¶ä¾èµ–å®‰è£…å®Œæˆ
- âœ… Reactæ„å»ºé€šè¿‡ (`npm run build`)
- âœ… ç›®å½•ç»“æ„ç¬¦åˆè§„åˆ’

### ä¸‹ä¸€æ­¥
- å®ç°æ•°æ®æ¨¡å‹å®šä¹‰
- é…ç½®æ•°æ®åº“è¿æ¥
- å®ç°Bç«™APIé›†æˆ
- å¼€å‘å‰ç«¯ç•Œé¢


## [2026-02-01 02:34] Task 2: æ•°æ®åº“è®¾è®¡ä¸å®ç°

### è¡¨ç»“æ„è®¾è®¡å†³ç­–

#### 1. settings è¡¨ - ç³»ç»Ÿé…ç½®
- **è®¾è®¡æ¨¡å¼**: Key-Valueæ¨¡å¼
- **ä¼˜åŠ¿**: çµæ´»æ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹è¡¨ç»“æ„å³å¯æ·»åŠ æ–°é…ç½®é¡¹
- **é…ç½®é¡¹**:
  - `ai_api_key`: OpenAI API Key
  - `ai_api_base`: API Base URL
  - `ai_model`: æ¨¡å‹åç§°
  - `bilibili_cookie`: å®Œæ•´Cookieå­—ç¬¦ä¸²

#### 2. analysis_history è¡¨ - åˆ†æå†å²è®°å½•ï¼ˆæ°¸ä¹…ä¿å­˜ï¼‰
- **ç”¨é€”**: è®°å½•æ‰€æœ‰åˆ†æä»»åŠ¡çš„å®Œæ•´å†å²
- **å…³é”®å­—æ®µ**:
  - `status`: ä»»åŠ¡çŠ¶æ€ï¼ˆpending/processing/completed/failedï¼‰
  - `keywords`, `brands`, `dimensions`: JSONæ•°ç»„å­˜å‚¨ï¼Œé¿å…å¤šè¡¨å…³è”
  - `video_count`, `comment_count`: ç»Ÿè®¡æŠ“å–æ•°é‡
- **ç´¢å¼•ç­–ç•¥**: ä¸º `category`, `status`, `created_at` æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢

#### 3. reports è¡¨ - æŠ¥å‘Šæ•°æ®ï¼ˆæ°¸ä¹…ä¿å­˜ï¼‰
- **ç”¨é€”**: å­˜å‚¨AIç”Ÿæˆçš„å®Œæ•´åˆ†ææŠ¥å‘Š
- **å­˜å‚¨æ ¼å¼**: `report_data` å­—æ®µå­˜å‚¨JSONæ ¼å¼æŠ¥å‘Š
- **JSONç»“æ„**:
  ```json
  {
    "brands": ["æˆ´æ£®", "å°ç±³"],
    "dimensions": [{"name": "å¸åŠ›", "description": "..."}],
    "scores": {"æˆ´æ£®": {"å¸åŠ›": 9.2}},
    "recommendation": "è´­ä¹°å»ºè®®..."
  }
  ```

#### 4. raw_comments è¡¨ - åŸå§‹è¯„è®ºï¼ˆä¸´æ—¶æ•°æ®ï¼Œ3å¤©æ¸…ç†ï¼‰
- **ç”¨é€”**: ä¸´æ—¶å­˜å‚¨æŠ“å–çš„åŸå§‹è¯„è®ºæ•°æ®
- **æ¸…ç†ç­–ç•¥**: å¯åŠ¨æ—¶è‡ªåŠ¨åˆ é™¤ `created_at < NOW() - 3 days` çš„è®°å½•
- **è®¾è®¡ç†ç”±**: åŸå§‹è¯„è®ºä»…ç”¨äºAIåˆ†æï¼Œåˆ†æå®Œæˆåæ— éœ€é•¿æœŸä¿å­˜ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

### æ•°æ®æ¸…ç†ç­–ç•¥

- **æ¸…ç†èŒƒå›´**: ä»…æ¸…ç† `raw_comments` è¡¨
- **æ¸…ç†æ—¶æœº**: ç¨‹åºå¯åŠ¨æ—¶ï¼ˆ`database.InitDB` å‡½æ•°ä¸­è°ƒç”¨ `CleanOldComments`ï¼‰
- **æ¸…ç†æ¡ä»¶**: `created_at < NOW() - 3 days`
- **ä¸å½±å“**: `analysis_history` å’Œ `reports` è¡¨ï¼ˆæ°¸ä¹…ä¿å­˜ï¼‰
- **å®¹é”™å¤„ç†**: æ¸…ç†å¤±è´¥ä¸å½±å“ç¨‹åºå¯åŠ¨ï¼Œä»…è®°å½•è­¦å‘Šæ—¥å¿—

### GORMä½¿ç”¨æ¨¡å¼

- **è‡ªåŠ¨è¿ç§»**: ä½¿ç”¨ `AutoMigrate` è‡ªåŠ¨åˆ›å»º/æ›´æ–°è¡¨ç»“æ„
- **ç´¢å¼•ä¼˜åŒ–**: ä½¿ç”¨ `gorm:"index"` ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- **å¤§æ–‡æœ¬å­˜å‚¨**: ä½¿ç”¨ `gorm:"type:text"` å­˜å‚¨JSONå’Œé•¿æ–‡æœ¬
- **å”¯ä¸€çº¦æŸ**: ä½¿ç”¨ `gorm:"uniqueIndex"` é˜²æ­¢é‡å¤æ•°æ®ï¼ˆå¦‚ `comment_id`ï¼‰
- **é»˜è®¤å€¼**: ä½¿ç”¨ `gorm:"default:0"` è®¾ç½®å­—æ®µé»˜è®¤å€¼

### éªŒè¯ç»“æœ

âœ… æ•°æ®åº“æ–‡ä»¶æˆåŠŸåˆ›å»º: `data/bilibili-analyzer.db` (80KB)
âœ… 4ä¸ªè¡¨ç»“æ„æ­£ç¡®åˆ›å»º:
  - `settings` (1ä¸ªå”¯ä¸€ç´¢å¼•)
  - `analysis_histories` (4ä¸ªç´¢å¼•)
  - `reports` (3ä¸ªç´¢å¼•)
  - `raw_comments` (6ä¸ªç´¢å¼•)
âœ… 3å¤©æ¸…ç†é€»è¾‘éªŒè¯é€šè¿‡:
  - æ’å…¥4å¤©å‰çš„æµ‹è¯•æ•°æ® â†’ é‡å¯ç¨‹åº â†’ æ—§æ•°æ®è¢«æ¸…ç†
  - æ’å…¥1å¤©å‰çš„æµ‹è¯•æ•°æ® â†’ é‡å¯ç¨‹åº â†’ æ–°æ•°æ®ä¿ç•™
  - æ¸…ç†æ—¥å¿—: "ğŸ—‘ï¸ Cleaned 1 old comments (older than 3 days)"

### æŠ€æœ¯è¦ç‚¹

1. **æ•°æ®åº“è·¯å¾„**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `data/bilibili-analyzer.db`ï¼Œä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œç¨‹åº
2. **ä¾èµ–ç®¡ç†**: ä½¿ç”¨ `go get` å®‰è£… `gorm.io/gorm` å’Œ `gorm.io/driver/sqlite`
3. **é”™è¯¯å¤„ç†**: æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥æ—¶ä½¿ç”¨ `log.Fatalf` ç»ˆæ­¢ç¨‹åº
4. **æ—¥å¿—ç¾åŒ–**: ä½¿ç”¨emojiå›¾æ ‡ï¼ˆâœ… âŒ ğŸ—‘ï¸ ğŸš€ï¼‰æå‡æ—¥å¿—å¯è¯»æ€§

### åç»­ä¼˜åŒ–å»ºè®®

- è€ƒè™‘æ·»åŠ æ•°æ®åº“è¿æ¥æ± é…ç½®ï¼ˆSQLiteé»˜è®¤å•è¿æ¥ï¼‰
- ä¸ºé«˜é¢‘æŸ¥è¯¢æ·»åŠ å¤åˆç´¢å¼•ï¼ˆå¦‚ `category + created_at`ï¼‰
- è€ƒè™‘ä½¿ç”¨GORMçš„è½¯åˆ é™¤åŠŸèƒ½ï¼ˆ`gorm.DeletedAt`ï¼‰æ›¿ä»£ç‰©ç†åˆ é™¤
- æ·»åŠ æ•°æ®åº“å¤‡ä»½æœºåˆ¶ï¼ˆå®šæœŸå¤‡ä»½ `bilibili-analyzer.db` æ–‡ä»¶ï¼‰
